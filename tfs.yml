queue: Hosted VS2017

steps:

- checkout: self
  clean: true

- powershell: |
    reg ADD "HKLM\Software\Microsoft\StrongName\Verification\*,*" /f
    if ($env:PROCESSOR_ARCHITECTURE -eq "AMD64") {
      reg ADD "HKLM\Software\Wow6432Node\Microsoft\StrongName\Verification\*,*" /f
    }

- task: DotNetCoreInstaller@0
  inputs:
    version: '2.1.4'

- task: CmdLine@2
  inputs:
    script: 'mkdir "$(Build.ArtifactStagingDirectory)\binlogs"'
    
- task: MSBuild@1
  displayName: Restore
  inputs:
    solution: build.proj
    msbuildArguments: /t:Restore /bl:"$(Build.ArtifactStagingDirectory)\binlogs\restore.binlog"

- task: MSBuild@1
  displayName: Build
  inputs:
    solution: build.proj
    msbuildArguments: /t:All /p:PackageOutputPath="$(Build.ArtifactStagingDirectory)" /bl:"$(Build.ArtifactStagingDirectory)\binlogs\build.binlog"

- task: VSTest@2
  displayName: Test
  inputs:
    testAssemblyVer2: src\Build\**\*.Tests.dll
    runInParallel: 'true'
    codeCoverageEnabled: 'true'
    publishRunAttachments: 'true'

- task: PublishBuildArtifacts@1
  inputs:
    PathtoPublish: '$(Build.ArtifactStagingDirectory)\binlogs'
    ArtifactName: 'logs'
    ArtifactType: 'Container'
  continueOnError: true
  condition: always()
    
- task: PublishBuildArtifacts@1
  displayName: Publish Artifact
  condition: always()
  inputs:
    PathtoPublish: $(Build.ArtifactStagingDirectory)
    ArtifactName: output
    ArtifactType: Container