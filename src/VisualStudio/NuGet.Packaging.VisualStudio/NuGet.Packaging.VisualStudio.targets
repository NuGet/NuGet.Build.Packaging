<?xml version="1.0" encoding="utf-8" standalone="no"?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
	<PropertyGroup>
		<StartAction>Program</StartAction>
		<StartProgram>$(MSBuildProgramFiles32)\Microsoft Visual Studio $(VisualStudioVersion)\Common7\IDE\devenv.exe</StartProgram>
		<StartArguments>/rootsuffix exp</StartArguments>

		<NoGlobalAssemblyInfo>true</NoGlobalAssemblyInfo>
	</PropertyGroup>

	<ItemGroup>
		<!-- NOTE: this will only work if the solution was built at least once from the command line, 
			 since the project reference below would have built the package in that case. -->
		<Content Include="..\..\Build\NuGet.Build.Packaging.Tasks\bin\$(Configuration)\*.nupkg" 
				 Condition="'$(BuildingInsideVisualStudio)' == 'true'">
			<Link>%(Filename)%(Extension)</Link>
			<IncludeInVSIX>true</IncludeInVSIX>
		</Content>
		<!-- We can't reference the project when building from VS because that will lock the output tasks assembly -->
		<ProjectReference Include="..\..\Build\NuGet.Build.Packaging.Tasks\NuGet.Build.Packaging.Tasks.csproj"
						  Condition="'$(BuildingInsideVisualStudio)' != 'true'">
			<Project>{a3d231d7-31e4-4a70-8cd1-7246c7d069f6}</Project>
			<Name>NuGet.Build.Packaging.Tasks</Name>
			<AdditionalProperties>PackOnBuild=true</AdditionalProperties>
			<IncludeOutputGroupsInVSIXLocalOnly>PackageOutputGroup</IncludeOutputGroupsInVSIXLocalOnly>
			<IncludeOutputGroupsInVSIX>PackageOutputGroup</IncludeOutputGroupsInVSIX>
			<Private>False</Private>
		</ProjectReference>
	</ItemGroup>

	<Target Name="GetVersion" DependsOnTargets="GitVersion" Returns="$(Version)">
		<PropertyGroup>
			<Version Condition=" '$(Configuration)' == 'Release' ">$(GitSemVerMajor).$(GitSemVerMinor).$(GitSemVerPatch)</Version>
			<Version Condition=" '$(Configuration)' != 'Release' ">1.0.0</Version>
		</PropertyGroup>
	</Target>

	<Target Name="CopyVsixToOut" AfterTargets="CreateVsixContainer" DependsOnTargets="GetVersion" Condition="'$(Out)' != ''">
		<ItemGroup>
			<TargetVsixContainer Include="$(TargetVsixContainer)" />
		</ItemGroup>
		<!-- Copy the evergreen filename -->
		<Copy SourceFiles="@(TargetVsixContainer)" DestinationFolder="$(Out)" />
		<!-- And also a versioned filename -->
		<Copy SourceFiles="@(TargetVsixContainer)" DestinationFiles="$(Out)\%(TargetVsixContainer.Filename).$(Version)%(TargetVsixContainer.Extension)" />
	</Target>

	<!-- Because envdte comes from a nuget package, we can't set the EmbedInteropTypes to true in the project, so we do it here -->
	<Target Name="EmbedInteropTypes" AfterTargets="ResolveNuGetPackageAssets">
		<ItemGroup>
			<Reference Condition=" '%(Filename)' == 'envdte80' ">
				<EmbedInteropTypes>True</EmbedInteropTypes>
			</Reference>
		</ItemGroup>
	</Target>
</Project>